diff -Naur linux_ori/fs/ext4/xattr.c linux/fs/ext4/xattr.c
--- linux_ori/fs/ext4/xattr.c	2023-03-13 17:18:25.000000000 +0800
+++ linux/fs/ext4/xattr.c	2023-05-30 13:44:03.835764855 +0800
@@ -2254,8 +2254,9 @@
 	struct ext4_xattr_search *s = &is->s;
 	int error;
 
-	if (EXT4_I(inode)->i_extra_isize == 0)
+	if (!EXT4_INODE_HAS_XATTR_SPACE(inode))
 		return -ENOSPC;
+		
 	error = ext4_xattr_set_entry(i, s, handle, inode, false /* is_block */);
 	if (error)
 		return error;
